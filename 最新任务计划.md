# ğŸŒ FiWA-Diff ä¸–ç•Œæ¨¡å‹å¢å¼ºç‰ˆï¼šä¼˜åŒ–æ€è·¯ä¸å®ç°ç¤ºä¾‹

## 1. ä¼˜åŒ–æ€»ä½“æ€è·¯

æœ¬æ–¹æ¡ˆæ—¨åœ¨å°†ä¸–ç•Œæ¨¡å‹ï¼ˆWorld Modelï¼‰çš„æ€æƒ³å¼•å…¥ FiWA-Diff é¥æ„Ÿè¶…åˆ†è¾¨ç‡æ¶æ„ï¼Œä½¿æ¨¡å‹ä»ã€Œåƒç´ æ˜ å°„å™¨ã€è¿›åŒ–ä¸ºã€Œç†è§£åœºæ™¯é€»è¾‘çš„ç”Ÿæˆå™¨ã€ã€‚  
æ ¸å¿ƒç›®æ ‡æ˜¯åœ¨ä¿æŒåŸæœ‰é«˜æŒ‡æ ‡ï¼ˆPSNRã€SSIMã€SAMã€ERGASã€Q8ï¼‰çš„åŸºç¡€ä¸Šï¼Œå¼•å…¥ä¸–ç•Œä¸€è‡´æ€§çº¦æŸä¸å¯è§£é‡Šæœºåˆ¶ï¼Œä½¿ç”Ÿæˆç»“æœæ›´ç¨³å®šã€æ›´çœŸå®ã€æ›´ç¬¦åˆç‰©ç†è§„å¾‹ã€‚

### ğŸ§  äº”å¤§æ¨¡å—æ¦‚è¿°

| æ¨¡å— | ç±»å‹ | ç‰©ç†/æ•°å­¦æ„ä¹‰ | å¯¹æŒ‡æ ‡å½±å“ |
|------|------|---------------|-------------|
| **WSM** ä¸–ç•ŒçŠ¶æ€è®°å¿† | æ—¶åºä¸€è‡´æ€§ | æ–¹å·®ç¼©å‡ï¼ˆVarâ†“ï¼‰ | PSNRâ†‘ã€SSIMâ†‘ |
| **DCA-FIM** å¯å½¢å˜å¯¹é½ | å‡ ä½•ä¸€è‡´æ€§ | é…å‡†è¯¯å·®é¡¹å‡å°‘ | PSNRâ†‘ã€è¾¹ç¼˜ä¼ªå½±â†“ |
| **DSC** å¯å¾®ä¼ æ„Ÿé“¾ | å…‰è°±ä¸€è‡´æ€§ | SAMä¸Šç•Œæ”¶ç´§ | SAMâ†“ã€ERGASâ†“ |
| **WAC-X** è·¨å¸¦é¢‘åŸŸä¸€è‡´ | é¢‘è°±ä¸€è‡´æ€§ | é«˜é¢‘èƒ½é‡å®ˆæ’ | PSNRâ†‘ã€çº¹ç†çœŸå® |
| **GeoPos + Patch Prior** ä¸–ç•Œå…ˆéªŒ | æ³›åŒ–ä¸ç»“æ„æµå½¢ | æ³›åŒ–è¯¯å·®ä¸Šç•Œâ†“ | Q8â†‘ã€ä¸»è§‚è´¨é‡â†‘ |

### ğŸŒ ç»Ÿä¸€ä¼˜åŒ–ç›®æ ‡ï¼ˆMAPå½¢å¼ï¼‰

\[
\min_{\hat I}\|\hat I-I^\star\|_2^2
+\lambda_s\mathcal{R}_{\text{sens}}
+\lambda_g\mathcal{R}_{\text{geom}}
+\lambda_w\mathcal{R}_{\text{wac-x}}
+\lambda_p\mathcal{R}_{\text{patch}},
\quad
\hat I\in\mathcal{C}(h_t,\text{GeoPos})
\]

å…¶ä¸­ï¼š
- \( \mathcal{R}_{\text{sens}} \)ï¼šå¯å¾®ç‰©ç†ä¸€è‡´æ€§ï¼ˆDSCï¼‰  
- \( \mathcal{R}_{\text{geom}} \)ï¼šå‡ ä½•ä¸€è‡´æ€§ï¼ˆDCAï¼‰  
- \( \mathcal{R}_{\text{wac-x}} \)ï¼šé¢‘åŸŸä¸€è‡´æ€§ï¼ˆWAC-Xï¼‰  
- \( \mathcal{R}_{\text{patch}} \)ï¼šç”Ÿæˆæµå½¢çº¦æŸï¼ˆPatch Priorï¼‰  
- \( \mathcal{C}(h_t, \text{GeoPos}) \)ï¼šç”±ä¸–ç•ŒçŠ¶æ€ \(h_t\) å’Œå‡ ä½•ç¼–ç æ§åˆ¶çš„å¯è¡Œé›†ã€‚

---

## 2. æ•°å­¦æ¨å¯¼æ‘˜è¦

### 2.1 DSC: å¯å¾®ä¼ æ„Ÿé“¾ä¸€è‡´æ€§ â†’ å…‰è°±è¯¯å·®æŠ‘åˆ¶

\[
\mathcal{R}_{\text{sens}}=
\|\mathsf{MTF}(\sum_b r_b\hat I_b)-PAN\|_1
+\alpha\|\mathsf{MTF}(D\!\downarrow(\hat I))-LRMS\|_1
\]

\[
r^\top(\hat I-I^\star)\to 0
\Rightarrow \text{SAM}(\hat I,I^\star)\downarrow,\;\text{ERGAS}\downarrow
\]

---

### 2.2 DCA-FIM: å½¢å˜è¡¥å¿å¯¹é½ â†’ PSNR/SSIM æå‡

\[
I^\star(x+\mathbf{u}) \approx I^\star(x)+\nabla I^\star(x)\cdot\mathbf{u},
\quad
\epsilon'=\nabla I^\star\cdot(\mathbf{u}-\hat{\mathbf{u}})
\Rightarrow \mathrm{MSE}\downarrow
\]

---

### 2.3 WSM: ä¸–ç•ŒçŠ¶æ€è®°å¿† â†’ æ–¹å·®ç¼©å‡ç¨³å®šç”Ÿæˆ

\[
h_t=\Phi(h_{t+1},\mathrm{Pool}(F_t)),
\quad
\mathrm{Var}(\tilde x_0)=\mathrm{Var}(\hat x_0)(1-\rho^2)
\Rightarrow \mathrm{MSE}\downarrow,\;\text{PSNR}\uparrow
\]

---

### 2.4 WAC-X: è·¨å¸¦é¢‘åŸŸä¸€è‡´ + PANé—¨æ§ â†’ é«˜é¢‘çœŸå®

\[
\mathcal{R}_{\text{wac-x}}=
\sum_{b_1\neq b_2}\|H_{b_1}-H_{b_2}\|_1
+\beta\,\|G\odot \mathrm{HF}(\hat I)\|_1
\]

å…¶ä¸­ \(G=\mathrm{norm}(|\mathrm{HF}(PAN)|)\)ã€‚  
â†’ é«˜é¢‘è¯¯å·®èƒ½é‡ä¸‹é™ â‡’ PSNRâ†‘ã€ä¼ªå½±â†“ã€‚

---

### 2.5 Patch Prior: æµå½¢çº¦æŸ â†’ æŠ‘åˆ¶è¿‡é”åŒ–ä¼ªå½±

\[
\mathcal{R}_{\text{patch}}=\sum_p\min_z\|\hat I_p-G(z)\|^2,
\quad
\mathbb{E}\|\hat I-I^\star\|^2=\text{bias}^2+\text{variance}\downarrow
\]

---

## 3. æ¨¡å—å®ç°ç¤ºä¾‹ä»£ç 

### 3.1 World State Memory (WSM)

```python
class WorldStateMemory(nn.Module):
    def __init__(self, d):
        super().__init__()
        self.cell = nn.GRUCell(d, d)
        self.to_gamma = nn.Linear(d, d)
        self.to_beta = nn.Linear(d, d)

    def forward(self, feat, h_next):
        pooled = feat.mean(dim=[2,3])
        h_t = self.cell(pooled, h_next)
        gamma, beta = self.to_gamma(h_t), self.to_beta(h_t)
        return h_t, gamma, beta
```

**è°ƒç”¨æ–¹å¼ï¼š**

```python
h = torch.zeros(B, C, device=x.device)
for t in timesteps:
    feat = encoder(x_t, cond)
    h, g, b = wsm(feat, h)
    x_t = decoder(feat, gamma=g, beta=b)
```

---

### 3.2 Deformable Cross-Attention (DCA-FIM)

```python
class DCAModule(nn.Module):
    def __init__(self, dim, kpoints=4):
        super().__init__()
        self.offset = nn.Conv2d(dim, 2*kpoints, 3, 1, 1)
        self.weight = nn.Conv2d(dim, kpoints, 3, 1, 1)
        self.conv_out = nn.Conv2d(dim, dim, 1)

    def forward(self, q_lrms, k_pan, v_pan):
        off = self.offset(q_lrms)
        w = torch.softmax(self.weight(q_lrms), dim=1)
        sampled = deformable_sample(v_pan, off)  # åŒçº¿æ€§é‡‡æ ·
        out = (w.unsqueeze(-1)*sampled).sum(1)
        return self.conv_out(out)
```

---

### 3.3 Differentiable Sensor Consistency (DSC)

```python
def sensor_forward(hrms, R, mtf_kernel):
    pan_syn = (hrms * R.view(1,-1,1,1)).sum(1, keepdim=True)
    return F.conv2d(pan_syn, mtf_kernel, padding="same")

def dsc_loss(hrms, PAN, LRMS, R, mtf):
    L_pan = F.l1_loss(sensor_forward(hrms, R, mtf), PAN)
    L_lrms = F.l1_loss(sensor_forward(F.avg_pool2d(hrms, 4), R, mtf), LRMS)
    return L_pan + 0.3 * L_lrms
```

---

### 3.4 Patch Prior Refiner (å…è®­ç»ƒ)

```python
class PatchPriorRefiner:
    def __init__(self, generator, patch_size=32):
        self.gen = generator.eval().requires_grad_(False)
        self.k = patch_size

    def loss(self, x):
        patches = x.unfold(2,self.k,self.k).unfold(3,self.k,self.k)
        patches = patches.contiguous().view(-1,3,self.k,self.k)
        recon = self.gen(patches)
        return F.mse_loss(recon, patches)
```

---

## 4. è®­ç»ƒä¸æ¨ç†æµç¨‹

### 4.1 è®­ç»ƒé˜¶æ®µ

```python
loss_total = loss_diff + \
             Î»s*dsc_loss(hr, PAN, LR, R, mtf) + \
             Î»g*dca_loss(features_lr, features_pan) + \
             Î»w*wacx_loss(hr, lr, PAN) + \
             Î»p*refiner.loss(hr)
loss_total.backward()
optimizer.step()
```

---

### 4.2 æ¨ç†é˜¶æ®µï¼ˆå…è®­ç»ƒå¢å¼ºï¼‰

```python
with torch.no_grad():
    hr = model.infer(LRMS, PAN)
    hr = DSC_refine(hr, PAN, LRMS)     # å¯å¾®ç‰©ç†ä¸€è‡´ä¿®æ­£
    hr = WACX_gate(hr, PAN)            # é«˜é¢‘é—¨æ§
    hr = PatchRefine(hr, generator)    # Patch çº§ä¿®è¡¥
save_image(hr, "output_sr.png")
```

---

## 5. å®éªŒé¢„æœŸä¸ç†è®ºä¿è¯

| æŒ‡æ ‡              | æ•°å­¦ä¾æ®                       | é¢„æœŸå˜åŒ–         |
| --------------- | -------------------------- | ------------ |
| **PSNR / SSIM** | (DCA)+(WSM)+(WAC-X) å‡å°‘ MSE | +0.2~+0.4 dB |
| **SAM**         | (DSC) æ”¶ç´§è°±è§’ä¸Šç•Œ               | â†“0.1~0.3Â°    |
| **ERGAS**       | DSC + WAC-X æ”¹å–„å…¨å±€ä¸€è‡´æ€§        | â†“0.05~0.15   |
| **Q8 / è§†è§‰è´¨é‡**   | Patch Prior æµå½¢çº¦æŸ           | â†‘çº¹ç†è‡ªç„¶æ€§       |
| **æ³›åŒ–æ€§**         | å†»ç»“ GeoPos + ä¸–ç•Œå…ˆéªŒé™ä½å¤æ‚åº¦      | â†‘ç¨³å®šæ€§         |

---

## 6. æ¨¡å‹åˆ›æ–°æ€»ç»“

"æˆ‘ä»¬é¦–æ¬¡å°†ä¸–ç•Œæ¨¡å‹çš„éšçŠ¶æ€è®°å¿†ã€ç‰©ç†ä¸€è‡´æ€§å’Œç”Ÿæˆå¼å…ˆéªŒå¼•å…¥é¥æ„Ÿè¶…åˆ†è¾¨ç‡ä»»åŠ¡ï¼Œå®ç°äº†ä»åƒç´ æ˜ å°„åˆ°ä¸–ç•Œä¸€è‡´ç”Ÿæˆçš„è·¨è¶Šã€‚"

### âœ… ç‰¹ç‚¹

- ä¸ç ´ååŸ FiWA-Diff æ¥å£ç»“æ„
- å¯é€æ¨¡å—å¯ç”¨
- å¤§éƒ¨åˆ†å¢å¼ºå¯ **å…è®­ç»ƒ**
- æä¾›æ˜ç¡®çš„ç‰©ç†ä¸æ•°å­¦è§£é‡Š
- æå‡å®¢è§‚æŒ‡æ ‡ä¸ä¸»è§‚è´¨é‡

---

## 7. æ¨èé»˜è®¤å‚æ•°

| å‚æ•°       | å«ä¹‰         | é»˜è®¤å€¼   |
| -------- | ---------- | ----- |
| Î»s       | DSC æƒé‡     | 0.3   |
| Î»g       | DCA å‡ ä½•æƒé‡   | 0.05  |
| Î»w       | WAC-X é¢‘åŸŸæƒé‡ | 0.5   |
| Î»p       | Patch å…ˆéªŒæƒé‡ | 0.2   |
| éšçŠ¶æ€ç»´åº¦    | h_t å¤§å°     | 128   |
| Patch å°ºå¯¸ | refiner è¾“å…¥ | 32Ã—32 |

---

## ğŸ“˜ æœ€ä½³å®è·µå»ºè®®

- åœ¨è®­ç»ƒå‰å†»ç»“ ViT/DINO è¯­ä¹‰ç¼–ç å™¨
- åœ¨æ¨ç†é˜¶æ®µå¯ç”¨ DSC + WAC-X + PatchRefine
- ç”¨ EMA + Cosine LR ä¿éšœç¨³å®š
- è¾“å‡ºæ—¥å¿—ç›‘æ§ SAM / ERGAS æ”¹å–„è¶‹åŠ¿
